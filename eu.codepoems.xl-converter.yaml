id: eu.codepoems.xl-converter
runtime: org.kde.Platform
runtime-version: '6.8'
sdk: org.kde.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
base: io.qt.PySide.BaseApp
base-version: '6.8'
command: run.sh
build-options:
  env:
    - BASEAPP_REMOVE_WEBENGINE=1
    - BASEAPP_DISABLE_NUMPY=1
  append-path: /usr/lib/sdk/rust-stable/bin
cleanup-commands:
  - /app/cleanup-BaseApp.sh
finish-args:
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  - --filesystem=host
  - --socket=pulseaudio
modules:
  
  - name: libjxl
    buildsystem: cmake
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DBUILD_TESTING=OFF
      - -DJPEGXL_ENABLE_JPEGLI_LIBJPEG=OFF
      - -DJPEGXL_ENABLE_VIEWERS=OFF
      - -DJPEGXL_ENABLE_PLUGINS=OFF
      - -DJPEGXL_ENABLE_OPENEXR=OFF
      - -DJPEGXL_ENABLE_DEVTOOLS=OFF
    post-install:
      - mkdir -p /app/xl-converter/bin/linux
      - install -Dm755 /app/bin/cjxl /app/xl-converter/bin/linux/cjxl
      - install -Dm755 /app/bin/djxl /app/xl-converter/bin/linux/djxl
      - install -Dm755 /app/bin/jxlinfo /app/xl-converter/bin/linux/jxlinfo
      - install -Dm755 /app/bin/cjpegli /app/xl-converter/bin/linux/cjpegli
    sources:
      - type: git
        url: https://github.com/libjxl/libjxl.git
        tag: v0.11.1
        x-checker-data:
          - type: anitya
            project-id: 232764
            stable-only: true

  - name: libjpeg-turbo
    buildsystem: cmake
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
    post-install:
      - install -Dm755 $FLATPAK_DEST/bin/jpegtran $FLATPAK_DEST/xl-converter/bin/linux/jpegtran
    sources:
      - type: git
        url: https://github.com/libjpeg-turbo/libjpeg-turbo.git
        tag: 3.0.4
        x-checker-data:
          - type: anitya
            project-id: 1648
            stable-only: true
  
  - name: oxipng
    buildsystem: simple
    build-options:
      build-args:
        - --share=network
    build-commands:
      - cargo build --release
      - install -Dm755 target/release/oxipng $FLATPAK_DEST/xl-converter/bin/linux/oxipng
    sources:
      - type: git
        url: https://github.com/shssoichiro/oxipng.git
        tag: v9.1.3
        x-checker-data:
          - type: git
            tag-pattern: '^v([\\d.]+)$'
  
  - name: libavif
    buildsystem: simple
    build-options:
      build-args:
        - --share=network
      env:
        AOM_VERSION: 'v3.11.0'
        SVT_REPO: 'https://github.com/psy-ex/svt-av1-psy.git'
        SVT_VERSION: 'v2.3.0-B'
    build-commands:
      - |
        cd ext &&
        sed -i -E "s/v[0-9]+\.[0-9]+\.[0-9]+/${AOM_VERSION}/" aom.cmd &&
        sed -i -E "s#https://gitlab.com/AOMediaCodec/SVT-AV1\.git#${SVT_REPO} SVT-AV1#" svt.sh &&
        sed -i -E "s/v[0-9]+\.[0-9]+\.[0-9]+/${SVT_VERSION}/" svt.sh &&
        cat aom.cmd && cat svt.sh &&
        chmod +x libyuv.cmd libsharpyuv.cmd libjpeg.cmd zlibpng.cmd svt.sh aom.cmd &&
        ./libyuv.cmd &&
        ./libsharpyuv.cmd &&
        ./libjpeg.cmd &&
        ./zlibpng.cmd &&
        ./svt.sh &&
        ./aom.cmd
      - |
        mkdir -p build &&
        cd build &&
        cmake \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_SHARED_LIBS=0 \
          -DAVIF_BUILD_APPS=1 \
          -DAVIF_LIBYUV=LOCAL \
          -DAVIF_LIBSHARPYUV=LOCAL \
          -DAVIF_JPEG=LOCAL \
          -DAVIF_ZLIBPNG=LOCAL \
          -DAVIF_CODEC_SVT=LOCAL \
          -DAVIF_CODEC_AOM=LOCAL \
          -DCMAKE_AR=$(which gcc-ar) \
          -DCMAKE_RANLIB=$(which gcc-ranlib) \
          -DCMAKE_INSTALL_PREFIX=$FLATPAK_DEST \
          ..
      - |
        cd build &&
        make -j$FLATPAK_BUILDER_N_JOBS &&
        make install
    post-install:
      - install -Dm755 build/avifenc $FLATPAK_DEST/xl-converter/bin/linux/avifenc
      - install -Dm755 build/avifdec $FLATPAK_DEST/xl-converter/bin/linux/avifdec
    sources:
      - type: git
        url: https://aomedia.googlesource.com/libavif.git
        tag: v1.1.1
        x-checker-data:
          - type: anitya
            project-id: 178015
            stable-only: true

  - name: ImageMagick
    buildsystem: autotools
    config-opts:
      - --enable-static
      - --disable-shared
      - --enable-hdri
      - --with-quantum-depth=16
      - --with-modules
      - --without-perl
      - --without-magick-plus-plus
      - --with-png
      - --with-jpeg
      - --with-tiff
      - --with-webp
      - --with-jxl
      - --with-zstd
      - --with-bzlib
      - --with-lzma
      - --with-openjp2
      - --with-heic
      - --without-raw
      - --disable-opencl
      - --without-wmf
      - --without-uhdr
      - --without-djvu
      - --without-openexr
      - --without-raqm
      - --without-jbig
    post-install:
      - install -Dm755 utilities/magick $FLATPAK_DEST/xl-converter/bin/linux/imagemagick/magick
    sources:
      - type: git
        url: https://github.com/ImageMagick/ImageMagick.git
        tag: 7.1.1-43
        x-checker-data:
          - type: anitya
            project-id: 1372
            stable-only: true

  - name: exiftool
    buildsystem: simple
    build-commands:
      - perl Makefile.PL
      - make install
    sources:
      - type: git
        url: https://github.com/exiftool/exiftool.git
        tag: 13.25
        x-checker-data:
          type: anitya
          project-id: 6175
          stable-only: true
    modules:
      - name: exiftool-brotli
        buildsystem: simple
        build-options:
          build-args:
            - --share=network
        build-commands:
          - perl -e "use CPAN; CPAN::Shell->install('IO::Uncompress::Brotli');"
        post-install:
          - find ${FLATPAK_DEST}/lib/perl5/ -name \*.so -exec chmod u+w {} \;
        modules:
          - name: brotli
            buildsystem: cmake
            sources:
              - type: git
                url: https://github.com/google/brotli.git
                tag: v1.1.0
          - name: perl
            no-autogen: true
            config-opts:
              - des
              - Duseshrplib
            build-options:
              cflags: -fPIC
              ldflags: -fpic
            cleanup:
              - "*.h"
            post-install:
              - find ${FLATPAK_DEST}/lib/perl5/ -name \*.so -exec chmod u+w {} \;
            sources:
              - type: archive
                url: https://www.cpan.org/src/5.0/perl-5.40.1.tar.xz
                sha256: dfa20c2eef2b4af133525610bbb65dd13777ecf998c9c5b1ccf0d308e732ee3f
                x-checker-data:
                  type: anitya
                  project-id: 13599
                  stable-only: true
                  url-template: https://www.cpan.org/src/${major}.0/perl-$version.tar.xz
              - type: script
                dest-filename: configure
                commands:
                  - exec ./configure.gnu $@

  - python3-requirements.yaml
  
  - name: xl-converter
    buildsystem: simple
    build-commands:
      - install -Dm644 eu.codepoems.xl-converter.metainfo.xml $FLATPAK_DEST/share/metainfo/eu.codepoems.xl-converter.metainfo.xml
      - install -Dm644 xl-converter/misc/xl-converter.desktop $FLATPAK_DEST/share/applications/xl-converter.desktop
      - install -Dm755 run.sh $FLATPAK_DEST/bin/run.sh
      - mkdir -p $FLATPAK_DEST/xl-converter
      - cp -r xl-converter/* $FLATPAK_DEST/xl-converter/
    sources:
      - type: git
        # Swapt path for the following url when deploying:
        # url: https://github.com/JacobDev1/xl-converter.git
        path: xl-converter
        tag: v1.2.0
        dest: xl-converter
      - type: file
        path: eu.codepoems.xl-converter.metainfo.xml
      - type: script
        commands:
          - python3 /app/xl-converter/main.py
        dest-filename: run.sh